<!--TOTO OBSAHUJE UZ VSETKO CO MA MAT STRANKA-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Image and Video Processor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container my-5">
        <div class="row">
            <div class="col-md-4 border-end">
                <h2 class="mb-3">Upload ONLY VIDEO</h2>

                <!-- Video upload form and model/prompt form together -->
                <form method="POST" enctype="multipart/form-data" id="upload-form">
                    <input type="file" name="file" class="form-control mb-3" id="file-input" {% if filename %} {% endif %} required>
                    <button class="btn btn-primary w-100" type="submit" {% if filename %} {% endif %}>Upload</button>
                </form>

                {% if filename %}
                    <div class="mt-4">
                        {% if filename.endswith(('mp4', 'mov', 'avi')) %}
                            <video class="img-fluid" controls>
                                <source src="{{ url_for('static', filename='uploads/' + filename) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% else %}
                            <img src="{{ url_for('static', filename='uploads/' + filename) }}" class="img-fluid" alt="Uploaded Image">
                        {% endif %}
                    </div>
                {% endif %}

                {% if all_timelines_prompt %}
                    <h3 class="mt-4">Visualization of Results</h3>
                    {% for img, prompt_text in all_timelines_prompt %}
                        <div class="mb-4">
                            <p><strong>Prompt:</strong> {{ prompt_text[0] }}: {{ prompt_text[1] }}</p>
                            <img src="{{ img }}" alt="Timeline Visualization" class="img-fluid my-2">
                        </div>
                    {% endfor %}
                {% endif %}
                {% if timeline_all %}
                    <h3 class="mt-4">Merge timelines</h3>
                    {% for img in timeline_all %}
                        <div class="mb-4">
                            <img src="{{ img }}" alt="Timeline Visualization" class="img-fluid my-2">
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="col-md-8">
                <h2>Model and Prompt</h2>
                <!-- Model and prompt form -->
                <form method="POST">
                    <input type="hidden" name="filename" value="{{ filename }}">

                    <label for="model" class="form-label">Choose Model:</label>
                    <select id="model" name="model" class="form-select mb-3" required onchange="updateTasks()">
                        <option value="paligemma">PaliGemma</option>
                        <option value="florence2">Florence2</option>
                        <option value="paligemmaft">PaliGemmaFT</option>
                        <option value="florence2ft">Florence2FT</option>
                    </select>

                    <div id="prompts-container">
                        <div class="mb-3">
                            <label for="prompt_type-1" class="form-label">Choose Prompt Type:</label>
                            <select id="prompt_type-1" name="prompt_type-1" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="prompt_text-1" class="form-label">Enter Prompt Text:</label>
                            <input type="text" id="prompt_text-1" name="prompt_text-1" class="form-control">
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-primary w-100 mb-3" id="add-prompt-btn">Add Another Prompt</button>
                    <button class="btn btn-primary w-100" type="submit" {% if not filename %} disabled {% endif %}>Submit</button>
                </form>

                {% if frame_results %}
                    <h3 class="mt-4">Frame Results</h3>
                    {% if model == "paligemma"%}
                        <ul class="list-group">
                            {% for result in frame_results %}
                                <li class="list-group-item">{{ result }}</li>
                            {% endfor %}
                        </ul>
                    {% elif model == "paligemmaft"%}
                        <ul class="list-group">
                            {% for result in frame_results %}
                                <li class="list-group-item">{{ result }}</li>
                            {% endfor %}
                        </ul>
                    {% elif model == "florence2" %}
                        {% for result in frame_results %}
                            {% if result.get('\u003cCAPTION\u003e') %}
                                <p>{{ result.get('\u003cCAPTION\u003e') }}</p>
                            {% elif result.get('<VQA>') == prompt_text %}
                                <p>{{ result.get('<VQA>') | e }}</p>  <!-- Escape the value -->
                            {% elif result.get('\u003cOD\u003e') %}
                                <p>{{ result.get('\u003cOD\u003e') }}</p>
                            {% elif result.get('\u003cMORE_DETAILED_CAPTION\u003e') %}
                                <p>{{ result.get('\u003cMORE_DETAILED_CAPTION\u003e') }}</p>
                            {% endif %}
                        {% endfor %}
                    {% elif model == "florence2ft" %}
                        {% for result in frame_results %}
                            {% if result.get('\u003cCAPTION\u003e') %}
                                <p>{{ result.get('\u003cCAPTION\u003e') }}</p>
                            {% elif result.get('<VQA>') == prompt_text %}
                                <p>{{ result.get('<VQA>') | e }}</p>  <!-- Escape the value -->
                            {% elif result.get('\u003cOD\u003e') %}
                                <p>{{ result.get('\u003cOD\u003e') }}</p>
                            {% elif result.get('\u003cMORE_DETAILED_CAPTION\u003e') %}
                                <p>{{ result.get('\u003cMORE_DETAILED_CAPTION\u003e') }}</p>
                            {% endif %}
                        {% endfor %}

                    {% else %}
                        <p class="text-danger">Unsupported model selected.</p>
                    {% endif %}
                {% endif %}

                {% if all_classify %}
                    {% set classify_data = all_classify[0] %}
                    <h3 class="mt-4">Classification Results</h3>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(classify_data['labels']|length) %}
                                <tr>
                                    <td>{{ classify_data['labels'][i] }}</td>
                                    <td>{{ classify_data['scores'][i] | round(3) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let promptCount = 1;

        function updateTasks() {
            const model = document.getElementById("model").value;
            const promptType = document.getElementById(`prompt_type-${promptCount}`);

            promptType.innerHTML = "";

            if (model === "paligemma" || model === "paligemmaft") {
                promptType.innerHTML = `
                    <option value="detect">Detect</option>
                    <option value="answer">Answer</option>
                    <option value="caption">Caption</option>
                    <option value="describe">Describe</option>
                `;
            } else if (model === "florence2" || model === "florence2ft") {
                promptType.innerHTML = `
                    <option value="CAPTION_TO_PHRASE_GROUNDING">Detect</option>
                    <option value="VQA">Answer</option>
                    <option value="CAPTION">Caption</option>
                    <option value="MORE_DETAILED_CAPTION">Describe</option>
                `;
            }
        }

        // Function to remove a prompt
        function removePrompt(promptId) {
            const promptElement = document.getElementById(promptId);
            promptElement.remove();
        }

        document.getElementById("add-prompt-btn").addEventListener("click", function() {
            promptCount++;
            const container = document.getElementById("prompts-container");
            const newPrompt = document.createElement("div");
            newPrompt.classList.add("mb-3");
            newPrompt.id = `prompt-${promptCount}`;
            newPrompt.innerHTML = `
                <label for="prompt_type-${promptCount}" class="form-label">Choose Prompt Type:</label>
                <select id="prompt_type-${promptCount}" name="prompt_type-${promptCount}" class="form-select" required></select>
                <br>
                <label for="prompt_text-${promptCount}" class="form-label">Enter Prompt Text:</label>
                <input type="text" id="prompt_text-${promptCount}" name="prompt_text-${promptCount}" class="form-control">
                <button type="button" class="btn btn-danger mt-2" onclick="removePrompt('prompt-${promptCount}')">Delete</button>
            `;
            container.appendChild(newPrompt);
            updateTasks();
        });

        document.addEventListener("DOMContentLoaded", function() {
            updateTasks();
        });
    </script>
</body>
</html>




